# 剪一剪 - 打包指南

## 📦 打包方案说明

本项目提供两套打包方案，推荐使用 **PyInstaller**：

### 方案一：PyInstaller（推荐）✅

**优点：**
- 对PyQt6支持更好，自动收集Qt6 DLL
- 社区活跃，文档完善
- 一键打包，配置简单
- 兼容性好，生成的EXE可在多台电脑运行

**配置文件：** `剪一剪.spec`

**使用方法：**
```bash
# 方式1：一键打包（推荐）
双击运行 scripts\一键打包.bat

# 方式2：命令行
pyinstaller --clean --noconfirm 剪一剪.spec
```

### 方案二：cx_Freeze（备选）

**优点：**
- 跨平台支持
- 配置文件更灵活

**缺点：**
- 配置复杂
- 对PyQt6支持不如PyInstaller
- 需要手动处理DLL依赖

**配置文件：** `setup.py`

**使用方法：**
```bash
python setup.py build
```

## 🚀 快速开始

### 1. 环境检查
```bash
# 双击运行
scripts\错误诊断.bat

# 或手动检查
python --version
pip install -r requirements.txt
```

### 2. 一键打包
```bash
# 双击运行
scripts\一键打包.bat
```

### 3. 生成安装包
```bash
# 双击运行
scripts\生成安装包.bat

# 输出位置
releases\v2.0\剪一剪V2.0_YYYYMMDD_HHMMSS安装包\
```

### 4. 测试运行
```bash
# 直接运行
dist\剪一剪\剪一剪.exe

# 或双击
启动剪一剪.bat
```

## 🔧 常见问题解决

### Q1: 打包成功但EXE无法运行

**现象：** 双击EXE无反应或立即关闭

**解决方案：**
```bash
# 1. 检查依赖
scripts\错误诊断.bat

# 2. 以控制台模式测试
# 修改spec文件：console=True
# 重新打包查看错误信息

# 3. 检查防病毒软件
# 将项目目录加入白名单
```

### Q2: 提示缺少DLL文件

**现象：** "应用程序无法正常启动(0xc000007b)"

**解决方案：**
```bash
# 1. 安装 Microsoft Visual C++ Redistributable
# 下载地址：https://docs.microsoft.com/en-us/cpp/windows/latest-supported-vc-redist

# 2. 使用PyInstaller自动收集
# 确保spec配置包含完整datas
```

### Q3: 图标不显示或资源文件缺失

**现象：** EXE运行时图标默认或报错

**解决方案：**
```python
# 检查spec配置中的datas部分
datas=[
    ('assets\\app_icon.ico', 'assets'),
    ('config.json', '.'),
],
```

### Q4: OpenCV导入错误

**现象：** `ImportError: DLL load failed`

**解决方案：**
```bash
# 使用headless版本
pip uninstall opencv-python
pip install opencv-python-headless

# 或在spec中排除冲突模块
excludes=['opencv-python', 'cv2']
```

### Q5: 打包体积过大（>100MB）

**现象：** 生成文件体积很大

**优化方案：**
```python
# 1. 排除不必要模块
excludes=[
    'matplotlib',
    'tkinter',
    'unittest',
    'pytest',
    'IPython',
]

# 2. 使用UPX压缩
# 下载UPX：https://upx.github.io/
# 将upx.exe放在PATH中
```

## 📋 完整打包流程

### 步骤1：准备环境
```bash
# 安装Python 3.8+
# 安装依赖
pip install -r requirements.txt
pip install PyInstaller
```

### 步骤2：测试源码
```bash
# 运行应用
启动剪一剪.bat

# 检查功能正常
```

### 步骤3：执行打包
```bash
# 一键打包
scripts\一键打包.bat

# 等待完成
```

### 步骤4：验证结果
```bash
# 检查文件
ls -la dist\剪一剪\

# 测试运行
dist\剪一剪\剪一剪.exe
```

### 步骤5：生成安装包
```bash
# 生成安装包
scripts\生成安装包.bat

# 复制到其他机器测试
```

## 🔍 调试技巧

### 1. 查看详细日志
```bash
# 修改spec配置，启用console
exe = EXE(
    ...
    console=True,  # 显示控制台日志
    ...
)
```

### 2. 测试模块导入
```bash
# 进入Python测试
python
>>> from PyQt6.QtWidgets import QApplication
>>> from PIL import Image
>>> import cv2
>>> print("所有模块导入成功")
```

### 3. 单步打包测试
```bash
# 先检查spec语法
pyi-makespec --onefile --windowed src\main_qt.py

# 手动运行分析
pyinstaller --debug all 剪一剪.spec
```

## 📁 项目文件说明

```
剪一剪/
├── 剪一剪.spec          # PyInstaller配置文件（推荐）
├── setup.py             # cx_Freeze配置（备选）
├── requirements.txt     # Python依赖列表
├── 启动剪一剪.bat        # 快速启动（源码模式）
├── src/                 # 源代码
├── assets/              # 资源文件
├── scripts/             # 打包工具
│   ├── 一键打包.bat          # 自动打包
│   ├── 生成安装包.bat        # 生成发布包
│   ├── 错误诊断.bat          # 环境诊断
│   └── 启动剪一剪.bat        # 启动脚本
└── releases/            # 发布目录
    └── v2.0/            # 版本发布
        └── 剪一剪V2.0_*安装包/  # 打包产物
```

## 💡 最佳实践

1. **每次打包前先运行错误诊断**
   - `scripts\错误诊断.bat`
   - 确保环境正确

2. **使用虚拟环境**
   ```bash
   python -m venv venv
   venv\Scripts\activate
   pip install -r requirements.txt
   ```

3. **版本管理**
   - 使用Git标签管理版本
   - 每次打包前创建新标签

4. **测试多台机器**
   - 在不同Windows版本测试
   - 虚拟机中测试
   - 不同防病毒软件测试

5. **文档更新**
   - 更新README.md
   - 记录打包日志
   - 更新CHANGELOG.md

## 📞 技术支持

如果遇到问题：

1. **查看日志**：运行 `scripts\错误诊断.bat`
2. **检查文档**：查看本文件和README.md
3. **搜索问题**：Google搜索错误信息
4. **社区求助**：
   - PyInstaller Issues: https://github.com/pyinstaller/pyinstaller/issues
   - Stack Overflow: https://stackoverflow.com/questions/tagged/pyinstaller

---

**最后更新：** 2025-10-29
**文档版本：** V2.0
