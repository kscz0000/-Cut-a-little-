# 产品需求文档：剪一剪 V2.0 增强版 - V1.0

## 1. 综述 (Overview)

### 1.1 项目背景与核心问题

**项目背景：**
表情包分割器 V1.0 已成功实现基础的四宫格和九宫格自动分割功能，但在实际使用中，用户对功能的灵活性和可控性提出了更高要求。用户需要更直观的预览、更灵活的分割方式、以及更强大的批量处理能力。

**核心问题：**
1. **缺乏可视化预览**：用户无法在分割前看到效果，需要处理后才能确认
2. **分割模式受限**：仅支持2×2和3×3，无法满足多样化的分割需求
3. **调整能力不足**：无法微调分割位置，无法旋转图片
4. **批量处理体验差**：缺乏详细进度显示，无统一的结果管理功能

**目标用户：**
- 表情包制作者：需要快速分割和处理大量表情包素材
- 设计师：需要精确控制分割效果和输出质量
- 普通用户：希望简单易用，一键处理表情包

### 1.2 核心业务流程 / 用户旅程地图

1. **阶段一：图片导入与预览编辑** - 用户添加图片后，能直观地预览、旋转、调整分割方式
2. **阶段二：批量处理与进度管理** - 用户可批量处理多个文件，实时查看进度和处理状态
3. **阶段三：分割结果导出与管理** - 用户可灵活管理输出结果，支持打包、重命名等操作

---

## 2. 用户故事详述 (User Stories)

### 阶段一：图片导入与预览编辑

---

#### **US-01: 图片导入与可视化预览编辑**

*   **价值陈述 (Value Statement)**:
    *   **作为** 表情包处理用户
    *   **我希望** 在添加图片后能立即看到原图和分割后的预览效果，并能通过旋转、调整分割线等方式灵活编辑
    *   **以便于** 在实际处理前确认分割效果，避免重复操作，提高工作效率

*   **业务规则与逻辑 (Business Logic)**:
    1.  **前置条件**: 
        - 用户已启动应用程序
        - 系统支持的图片格式：JPG, JPEG, PNG, BMP, WEBP
        
    2.  **操作流程 (Happy Path)**: 
        - 用户点击"添加文件"按钮，选择1-10个图片文件
        - 系统在文件列表中显示所有已选文件（文件名）
        - 系统自动选中列表中第一个文件
        - 预览区域立即显示：
          - **左侧**：原图缩略图（200x200px）+ 元数据（尺寸、格式、自动检测的分割类型）
          - **右侧**：根据当前分割设置显示分割后的网格预览（每个缩略图自适应大小）
        - 用户可在原图预览区进行以下编辑操作：
          - **鼠标拖动旋转**：点击并拖动图片，围绕中心旋转至任意角度
          - **快捷旋转按钮**：点击 -90°/+90°/重置 按钮
          - **拖动分割线**：在设置行列数后，拖动横/纵分割线调整位置（实现不等宽/等高分割）
        - 任何调整操作后，右侧分割预览**立即更新**
        - 用户可在文件列表中切换选中不同文件，预览区同步更新
        
    3.  **异常处理 (Error Handling)**: 
        - **文件格式不支持**：提示"不支持的文件格式，请选择 JPG/PNG/BMP/WEBP 文件"
        - **文件损坏或无法读取**：提示"文件读取失败：[文件名]，请检查文件完整性"
        - **超过文件数量限制**（添加第11个文件）：弹出警告"已达文件数量上限（10个），无法继续添加"
        - **自定义行列数超出范围**：输入时实时校验，超出1-18范围时标红提示"范围：1-18"
        - **行列数同时为1**：提示"行列数不能同时为 1，至少为 2×1 或 1×2"
        - **图片尺寸过小**（小于100x100px）：警告"图片尺寸过小（[宽]x[高]px），分割后效果可能不佳"

*   **验收标准 (Acceptance Criteria)**:
    *   **场景1: 添加文件并自动预览**
        *   **GIVEN** 用户未添加任何文件
        *   **WHEN** 用户点击"添加文件"并选择 3 个 PNG 图片
        *   **THEN** 
            - 文件列表显示 3 个文件名
            - 第一个文件自动选中
            - 左侧显示第一个文件的原图缩略图和元数据
            - 右侧显示根据自动检测生成的分割预览
            - 文件计数显示"已选择 3 个文件"
    
    *   **场景2: 鼠标拖动旋转图片**
        *   **GIVEN** 用户已选中一个图片文件，预览区显示原图
        *   **WHEN** 用户在原图预览区点击并拖动鼠标
        *   **THEN** 
            - 图片围绕中心旋转，跟随鼠标移动
            - 底部实时显示旋转角度（如"旋转角度: 45°"）
            - 右侧分割预览同步更新，显示旋转后的分割效果
            - 松开鼠标后，旋转角度固定
    
    *   **场景3: 自定义行列数并预览**
        *   **GIVEN** 用户已选中一个文件，当前为自动检测模式（3×3）
        *   **WHEN** 用户在"自定义分割"区输入行数=4，列数=6，并点击"应用"
        *   **THEN** 
            - 右侧预览区立即显示 4×6 = 24 个分割小图的缩略图
            - 每个缩略图自动缩小以适应预览区域
            - 显示"分割结果: 4行×6列 = 24张"
            - 每张小图下方显示计算后的尺寸
    
    *   **场景4: 手动微调分割线**
        *   **GIVEN** 用户已设置 3×3 分割，原图预览区显示分割网格线
        *   **WHEN** 用户勾选"启用手动微调分割线"，并拖动第一条横向分割线向下移动 50px
        *   **THEN** 
            - 原图预览区的分割线位置实时更新
            - 右侧预览显示不等高的分割结果（第一行高度增加，其余行高度相应减少）
            - 分割后的尺寸信息实时更新
    
    *   **场景5: 超出文件数量限制**
        *   **GIVEN** 用户已添加 10 个文件
        *   **WHEN** 用户点击"添加文件"并尝试选择第 11 个文件
        *   **THEN** 
            - 系统拒绝添加，弹出提示框"已达文件数量上限（10个），无法继续添加"
            - 文件列表仍保持 10 个文件

---

*   **技术实现概要 (Technical Implementation Brief)**:
    
    *   **影响范围**: Python Tkinter 桌面应用主程序
    
    *   **前端 / 客户端 (Frontend / Client)**: 
        - **UI组件新增**：
          - 预览区域容器（左右分栏布局）
          - 原图预览Canvas（支持鼠标事件监听）
          - 分割预览网格容器（动态生成缩略图）
          - 旋转控制按钮组（-90°/+90°/重置）
          - 分割线拖动手柄（Canvas绘制的可拖动线条）
        
        - **交互逻辑**：
          - 文件选择后触发 `load_preview()` 方法
          - 鼠标事件绑定：`<Button-1>` 开始拖动，`<B1-Motion>` 旋转，`<ButtonRelease-1>` 结束
          - 参数变更时触发 `update_split_preview()` 方法（防抖处理，避免频繁刷新）
        
        - **状态管理**：
          - 当前选中文件索引
          - 每个文件的旋转角度（字典存储）
          - 每个文件的分割线位置（数组存储）
          - 全局分割参数（行数、列数、输出格式等）
    
    *   **页面布局线框图 (ASCII Wireframe)**:
        ```text
        +---------------------------------------------------------------------------------------------+
        | 表情包分割器 V2.0                                                          [最小化] [关闭] |
        +---------------------------------------------------------------------------------------------+
        | 文件选择区                                                                                  |
        | +---------------------------------------------------------+  +--------+  +--------+  +--------+
        | | 1. emoji_1.png                                          |  | 添加   |  | 删除   |  | 清空   |
        | | 2. grid_image.jpg                     <-- 当前选中      |  | 文件   |  | 选中   |  | 列表   |
        | | 3. sticker_pack.png                                     |  +--------+  +--------+  +--------+
        | +---------------------------------------------------------+                已选择 3 个文件
        |                                                                                             |
        +---------------------------------------------------------------------------------------------+
        | 预览与编辑区域                                                                              |
        | +-----------------------------------+    +---------------------------------------------+    |
        | | 原图预览 (可旋转、可调整分割线)   |    | 分割后预览 (实时更新)                       |    |
        | |                                   |    |                                             |    |
        | | +-----------------------------+   |    | +----+ +----+ +----+ +----+ +----+ +----+  |    |
        | | |            ⟲               |   |    | | 1  | | 2  | | 3  | | 4  | | 5  | | 6  |  |    |
        | | |      (鼠标拖动旋转)         |   |    | |166x| |166x| |166x| |166x| |166x| |166x|  |    |
        | | |                             |   |    | |333 | |333 | |333 | |333 | |333 | |333 |  |    |
        | | |      [图片预览]             |   |    | +----+ +----+ +----+ +----+ +----+ +----+  |    |
        | | |    ←可拖动分割线→          |   |    | +----+ +----+ +----+ +----+ +----+ +----+  |    |
        | | |----+----+----+----|        |   |    | | 7  | | 8  | | 9  | | 10 | | 11 | | 12 |  |    |
        | | |    ↑    |    ↑    |         |   |    | |166x| |166x| |166x| |166x| |166x| |166x|  |    |
        | | |  可拖动 |  分割   |      ↻  |   |    | |333 | |333 | |333 | |333 | |333 | |333 |  |    |
        | | +-----------------------------+   |    | +----+ +----+ +----+ +----+ +----+ +----+  |    |
        | |                                   |    | +----+ +----+ +----+ +----+ +----+ +----+  |    |
        | | 旋转角度: 0°                      |    | | 13 | | 14 | | 15 | | 16 | | 17 | | 18 |  |    |
        | | [↶ -90°] [↷ +90°] [🔄 重置]     |    | |166x| |166x| |166x| |166x| |166x| |166x|  |    |
        | |                                   |    | |333 | |333 | |333 | |333 | |333 | |333 |  |    |
        | | 原图: 1000x1000px  PNG            |    | +----+ +----+ +----+ +----+ +----+ +----+  |    |
        | | 检测类型: 自动 (3×6)              |    |                                             |    |
        | +-----------------------------------+    | 分割: 3×6 = 18张                            |    |
        |                                          | 每张尺寸: ~167x333px                        |    |
        |                                          +---------------------------------------------+    |
        +---------------------------------------------------------------------------------------------+
        | 分割设置                                                                                    |
        | +------------------------------------------------------------------------------------------+|
        | | 分割模式: ( √ ) 自动检测  ( ) 预设模式  ( ) 自定义                                      ||
        | |                                                                                          ||
        | | 预设快捷: [2×2] [2×3] [3×2] [3×3] [4×4] [5×5] [6×6] [更多...]                          ||
        | |                                                                                          ||
        | | 自定义分割:  行数 [ 3  ] × 列数 [ 6  ]   (范围: 1-18, 不能同时为1)                      ||
        | |              [ √ ] 启用手动微调分割线 (在预览区拖动调整)                                ||
        | |                                                                                          ||
        | | 输出格式: ( √ ) PNG  ( ) JPG  |  路径: ( √ ) 原图同目录  ( ) 自定义 [______] [浏览]   ||
        | +------------------------------------------------------------------------------------------+|
        +---------------------------------------------------------------------------------------------+
        | 处理日志                                         |  操作控制                                |
        | +----------------------------------------------+ |  +-------------------------------------+ |
        | | [14:35] 已选中: grid_image.jpg              | |  | 当前状态: 准备就绪                  | |
        | | [14:35] 检测到 3×6 布局                     | |  | 进度: ░░░░░░░░░░ 0%                 | |
        | | [14:36] 预览已加载，可调整分割线            | |  |                                     | |
        | | [14:36] 旋转角度: 0°                        | |  | +----------------------------------+| |
        | | [INFO] 准备处理 3 个文件...                 | |  | |       [开始处理全部]             || |
        | +----------------------------------------------+ |  | +----------------------------------+| |
        |                                                  |  | [打开输出文件夹]  [清空日志]        | |
        +---------------------------------------------------------------------------------------------+
        ```
    
    *   **后端 (Backend)**: 
        - **图像处理模块** (基于 Pillow)：
          - `rotate_image(image, angle)`: 旋转图片至指定角度
          - `generate_split_lines(rows, cols, width, height)`: 生成均匀分割线坐标
          - `adjust_split_line(line_index, new_position)`: 调整分割线位置
          - `crop_by_lines(image, h_lines, v_lines)`: 根据分割线坐标裁剪图片
        
        - **预览生成模块**：
          - `create_thumbnail(image, max_size)`: 生成缩略图
          - `generate_split_preview(image, rows, cols, lines)`: 生成分割预览网格
        
        - **参数验证模块**：
          - `validate_grid_size(rows, cols)`: 校验行列数范围和组合
          - `validate_file_count(count)`: 校验文件数量限制
    
    *   **数据库 / 存储 (Database / Storage)**: 
        - **settings.json 扩展字段**：
          ```json
          {
            "last_directory": "...",
            "output_format": "PNG",
            "default_grid_type": "auto",
            "custom_rows": 3,
            "custom_cols": 3,
            "enable_manual_lines": false,
            "last_rotation_angles": {},
            "window_size": "1000x750"
          }
          ```

---

*   **约束与边界 (Constraints & Boundaries)**: 
    - 文件数量：单次最多 10 个文件
    - 行列数范围：1-18，且不能同时为 1（即最小 2×1 或 1×2）
    - 旋转角度：0-360°，精度为 1°
    - 预览缩略图尺寸：原图最大 200x200px，分割后根据数量自适应（最小 50x50px）
    - 支持的图片格式：JPG, JPEG, PNG, BMP, WEBP
    - 建议原图尺寸：≥100x100px

*   **非功能性需求 (Non-Functional)**: 
    - **性能**：
      - 预览生成时间：单个文件 < 500ms
      - 旋转响应时间：< 100ms（帧率 ≥ 10fps）
      - 参数调整后预览更新：< 300ms
    
    - **易用性**：
      - 鼠标拖动旋转的灵敏度可调（默认：移动10px = 旋转10°）
      - 分割线拖动时有视觉反馈（高亮显示、吸附效果）
      - 所有操作支持撤销（Ctrl+Z）
    
    - **兼容性**：
      - 支持 Windows 10/11
      - 支持高DPI显示器（自动缩放）
    
    - **数据安全**：
      - 所有编辑操作不修改原文件
      - 预览数据仅存储在内存中
      - 用户设置自动保存到本地 JSON 文件


---

### 阶段二：批量处理与进度管理

---

#### **US-02: 批量处理与进度管理**

*   **价值陈述 (Value Statement)**:
    *   **作为** 需要处理大量表情包的用户
    *   **我希望** 能一次性添加多个文件，使用统一的参数批量处理，并实时查看详细的处理进度和结果
    *   **以便于** 高效完成批量任务，遇到错误时也能继续处理，节省时间成本

*   **业务规则与逻辑 (Business Logic)**:
    1.  **前置条件**: 
        - 用户已添加 1-10 个图片文件
        - 用户已在分割设置区配置好统一参数（行列数、输出格式、输出路径等）
        
    2.  **操作流程 (Happy Path)**: 
        - 用户点击"开始处理全部"按钮
        - 系统进入批量处理模式：
          - 按钮文字变为"处理中..."并禁用
          - 进度条开始从 0% 更新
        - 系统按文件列表顺序逐个处理：
          - 当前状态显示："正在处理: 3/10 - filename.png"
          - 预览区域切换到当前正在处理的文件
          - 应用用户设置的参数（旋转角度、行列数、分割线位置等）
          - 执行图片分割和保存操作
          - 进度条更新：30% → 40% → ...
        - 如果某个文件处理失败：
          - 记录错误信息到日志
          - 自动跳过，继续处理下一个文件
        - 所有文件处理完成后：
          - 进度条显示 100%
          - 弹出汇总提示框："处理完成！成功 8 个，失败 2 个，共耗时 12 秒"
          - 按钮恢复为"开始处理全部"并启用
          - 日志区显示详细的成功/失败列表
        
    3.  **异常处理 (Error Handling)**: 
        - **未添加文件**：点击"开始处理"时提示"请先添加图片文件"
        - **未设置分割参数**：如果自定义模式下行列数为空，提示"请设置分割行列数"
        - **单个文件处理失败**：
          - 记录错误："[14:37] 处理失败: corrupted.png - 文件损坏"
          - 跳过该文件，继续处理
          - 最终汇总中统计失败数量
        - **所有文件都失败**：提示"处理失败，请检查文件格式和完整性"
        - **磁盘空间不足**：提示"磁盘空间不足，已成功处理 X 个文件，剩余 Y 个无法保存"

*   **验收标准 (Acceptance Criteria)**:
    *   **场景1: 批量处理所有文件成功**
        *   **GIVEN** 用户已添加 5 个有效的 PNG 文件，并设置分割参数为 3×3
        *   **WHEN** 用户点击"开始处理全部"
        *   **THEN** 
            - 按钮变为"处理中..."并禁用
            - 进度条从 0% 逐步更新到 100%
            - 当前状态依次显示："正在处理: 1/5 - file1.png" ... "正在处理: 5/5 - file5.png"
            - 预览区实时显示当前处理文件的预览
            - 处理完成后弹出提示："处理完成！成功 5 个，失败 0 个，共耗时 X 秒"
            - 日志显示每个文件的处理结果
    
    *   **场景2: 部分文件处理失败**
        *   **GIVEN** 用户添加了 3 个文件，其中第 2 个文件损坏
        *   **WHEN** 用户点击"开始处理全部"
        *   **THEN** 
            - 第 1 个文件处理成功，日志显示"[INFO] 处理成功: file1.png"
            - 第 2 个文件失败，日志显示"[ERROR] 处理失败: file2.png - 文件读取错误"
            - 系统自动跳过第 2 个，继续处理第 3 个
            - 第 3 个文件处理成功
            - 最终提示："处理完成！成功 2 个，失败 1 个，共耗时 X 秒"
    
    *   **场景3: 详细进度显示**
        *   **GIVEN** 用户正在批量处理 10 个文件
        *   **WHEN** 系统正在处理第 6 个文件
        *   **THEN** 
            - 当前状态显示："正在处理: 6/10 - emoji_6.png"
            - 进度条显示 60%
            - 日志显示已处理文件的记录（前 5 个）
            - 预览区显示第 6 个文件的预览

---

*   **技术实现概要 (Technical Implementation Brief)**:
    
    *   **影响范围**: Python Tkinter 主程序 + 图像处理模块
    
    *   **前端 / 客户端 (Frontend / Client)**: 
        - **UI组件更新**：
          - 进度条组件：Progressbar (ttk)
          - 状态标签：实时更新当前处理文件信息
          - 处理按钮：动态切换文字和状态
        
        - **交互逻辑**：
          - 点击"开始处理"触发 `start_batch_processing()` 方法
          - 使用多线程处理（避免UI冻结）
          - 线程间通信：使用 Queue 传递进度和结果
    
    *   **后端 (Backend)**: 
        - **批量处理控制器**：逐个处理文件，记录结果，更新进度
        - **错误分类处理**：区分不同类型的错误并记录
    
    *   **数据库 / 存储 (Database / Storage)**: 
        - 处理日志仅保存在当前会话的内存中

---

*   **约束与边界 (Constraints & Boundaries)**: 
    - 批量处理文件数量：1-10 个
    - 所有文件使用统一的分割参数
    - 单个文件失败不影响其他文件的处理
    - 不支持中途暂停（V3.0 考虑添加）

*   **非功能性需求 (Non-Functional)**: 
    - **性能**：
      - 单个文件处理时间：< 2秒（1000x1000px，9宫格）
      - 进度更新频率：每处理完一个文件更新一次
    
    - **可靠性**：
      - 单个文件失败不导致程序崩溃
      - 所有错误都有详细日志记录
    
    - **易用性**：
      - 进度条和状态信息清晰可见
      - 处理完成后的汇总信息一目了然


---

### 阶段三：分割结果导出与管理

---

#### **US-03: 分割结果导出与管理**

*   **价值陈述 (Value Statement)**:
    *   **作为** 完成图片分割的用户
    *   **我希望** 能灵活地选择输出路径、管理输出文件命名，并提供打包、重命名、清理等便捷功能
    *   **以便于** 快速整理和分享分割结果，提高后续工作效率

*   **业务规则与逻辑 (Business Logic)**:
    1.  **前置条件**: 
        - 用户已完成至少一个文件的分割处理
        - 系统已生成分割结果文件
        
    2.  **操作流程 (Happy Path)**: 
        - **输出路径设置**：
          - 用户在分割设置区选择输出模式：
            - **原图同目录**（默认）：在每个原图所在文件夹创建 `原文件名_split/` 子文件夹
            - **自定义路径**：所有结果统一输出到用户指定的文件夹
          - 系统记住用户的选择，下次启动时自动应用
        
        - **文件命名规则**：
          - 使用**序号前缀命名**：`001_原文件名.png`, `002_原文件名.png`, ...
          - 序号为三位数（支持最多999张小图）
          - 保留原文件名（去除扩展名），便于识别来源
        
        - **处理完成后**：
          - 弹出提示框显示："处理完成！成功 8 个，失败 0 个，共耗时 12 秒"
          - 用户可点击"打开输出文件夹"按钮，系统自动打开最后一个处理文件的输出文件夹
        
        - **结果管理功能**：
          - **打开输出文件夹**：快速定位到结果目录
          - **导出为ZIP**：将当前会话所有分割结果打包成 `表情包分割结果_YYYYMMDD_HHMMSS.zip`
          - **批量重命名**：弹出对话框，允许用户修改命名规则（前缀、后缀、起始序号等）
          - **清理历史输出**：删除之前生成的分割结果文件夹（需二次确认）
        
    3.  **异常处理 (Error Handling)**: 
        - **输出路径不存在**：自动创建文件夹，如失败则提示"无法创建输出文件夹，请检查权限"
        - **文件名冲突**：自动追加时间戳 `_001`, `_002` 避免覆盖
        - **磁盘空间不足**：提示"磁盘空间不足，已保存 X 张图片，剩余 Y 张无法保存"
        - **ZIP导出失败**：提示"打包失败：[错误原因]，请检查文件权限"
        - **清理历史时文件被占用**：提示"部分文件正在使用中，无法删除"

*   **验收标准 (Acceptance Criteria)**:
    *   **场景1: 使用默认输出路径**
        *   **GIVEN** 用户选择"原图同目录"模式，原图路径为 `D:\图片\emoji.png`
        *   **WHEN** 用户处理该文件（3×3分割）
        *   **THEN** 
            - 系统在 `D:\图片\` 创建 `emoji_split\` 文件夹
            - 文件夹内包含 9 张图片：`001_emoji.png`, `002_emoji.png`, ..., `009_emoji.png`
            - 日志显示："完成: 9张图片 -> emoji_split"
    
    *   **场景2: 使用自定义输出路径**
        *   **GIVEN** 用户选择"自定义路径"模式，设置路径为 `D:\输出\`
        *   **WHEN** 用户处理 2 个文件（file1.png 和 file2.jpg）
        *   **THEN** 
            - 系统在 `D:\输出\` 创建两个文件夹：`file1_split\` 和 `file2_split\`
            - 每个文件夹内包含对应的分割结果
            - 处理完成后，"打开输出文件夹"打开 `D:\输出\file2_split\`（最后一个处理的）
    
    *   **场景3: 导出为ZIP**
        *   **GIVEN** 用户已处理 3 个文件，共生成 27 张分割图片
        *   **WHEN** 用户点击"导出为ZIP"按钮
        *   **THEN** 
            - 弹出保存对话框，默认文件名为 `表情包分割结果_20251023_143520.zip`
            - 用户选择保存路径后，系统将所有 3 个文件夹打包
            - 完成后提示："ZIP 导出成功：[保存路径]"
    
    *   **场景4: 批量重命名**
        *   **GIVEN** 用户已完成分割，输出文件为 `001_emoji.png`, `002_emoji.png`, ...
        *   **WHEN** 用户点击"批量重命名"，设置前缀为 `sticker_`，起始序号为 10
        *   **THEN** 
            - 文件重命名为：`sticker_010_emoji.png`, `sticker_011_emoji.png`, ...
            - 日志显示："批量重命名完成：9 个文件"
    
    *   **场景5: 清理历史输出**
        *   **GIVEN** 用户之前处理过多个文件，存在多个 `*_split\` 文件夹
        *   **WHEN** 用户点击"清理历史输出"
        *   **THEN** 
            - 弹出确认对话框："确定要删除所有历史分割结果吗？此操作不可撤销。"
            - 用户确认后，系统删除所有 `*_split\` 文件夹
            - 完成后提示："清理完成，已删除 X 个文件夹"

---

*   **技术实现概要 (Technical Implementation Brief)**:
    
    *   **影响范围**: Python Tkinter 主程序 + 文件系统操作模块
    
    *   **前端 / 客户端 (Frontend / Client)**: 
        - **UI组件新增**：
          - 输出路径选择组件（单选按钮 + 文件夹浏览器）
          - 结果管理按钮组（打开文件夹、导出ZIP、批量重命名、清理历史）
          - 批量重命名对话框（输入前缀、后缀、起始序号）
          - 确认对话框（清理历史时使用）
        
        - **交互逻辑**：
          - 输出路径选择持久化到 settings.json
          - 按钮点击触发对应的文件操作方法
          - ZIP 导出使用 Python 标准库 `zipfile`
    
    *   **后端 (Backend)**: 
        - **文件管理模块**：
          - `create_output_folder(base_path, folder_name)`: 创建输出文件夹
          - `save_split_images(images, output_folder, prefix)`: 保存分割图片
          - `export_to_zip(folder_list, zip_path)`: 打包为 ZIP
          - `batch_rename(folder, prefix, suffix, start_num)`: 批量重命名
          - `clean_history(base_path, pattern)`: 清理历史文件夹
        
        - **命名规则生成器**：
          - `generate_filename(index, original_name, prefix, suffix)`: 生成文件名
    
    *   **数据库 / 存储 (Database / Storage)**: 
        - **settings.json 扩展字段**：
          ```json
          {
            "output_mode": "same_dir",
            "custom_output_path": "",
            "filename_prefix": "",
            "filename_suffix": "",
            "start_index": 1
          }
          ```

---

*   **约束与边界 (Constraints & Boundaries)**: 
    - 输出文件夹命名：`原文件名_split/`
    - 文件命名格式：`{序号}_{原文件名}.{格式}`
    - 序号范围：001-999（支持最多 999 张分割图）
    - ZIP 文件命名：`表情包分割结果_YYYYMMDD_HHMMSS.zip`
    - 清理历史仅删除符合 `*_split/` 模式的文件夹

*   **非功能性需求 (Non-Functional)**: 
    - **性能**：
      - ZIP 打包速度：> 10MB/s
      - 批量重命名：100 个文件 < 1 秒
    
    - **安全性**：
      - 清理历史前必须二次确认
      - 所有删除操作记录到日志
    
    - **易用性**：
      - 默认文件名和路径符合用户习惯
      - 所有操作提供明确的反馈提示

---

## 3. 附录

### 3.1 技术栈

- **开发语言**：Python 3.8+
- **GUI 框架**：Tkinter (内置)
- **图像处理**：Pillow (PIL Fork)
- **配置存储**：JSON (标准库)
- **文件操作**：os, shutil (标准库)
- **打包工具**：zipfile (标准库)

### 3.2 开发优先级

**Phase 1（核心功能）**：
1. US-01：图片导入与可视化预览编辑
   - 预览功能（原图 + 分割后）
   - 自定义行列数（1-18）
   - 基础旋转（快捷按钮）

**Phase 2（增强功能）**：
2. US-01 增强：
   - 鼠标拖动旋转
   - 手动调整分割线
3. US-02：批量处理与进度管理

**Phase 3（管理功能）**：
4. US-03：分割结果导出与管理
   - 输出路径选择
   - 序号前缀命名
   - ZIP 导出、批量重命名、清理历史

### 3.3 未来规划 (V3.0)

- 支持中途暂停/恢复批量处理
- 撤销/重做功能（Ctrl+Z / Ctrl+Y）
- 更多预设模板（常见表情包尺寸）
- 拖拽文件添加
- 历史记录功能
- 云端同步设置

---

**文档版本**：V1.0  
**创建日期**：2025-10-23  
**最后更新**：2025-10-23  
**负责人**：产品经理（AI助手）  
**审核状态**：待用户最终确认
